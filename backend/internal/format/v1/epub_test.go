package format

import (
	"bytes"
	"context"
	"testing"

	"github.com/htchan/BookSpider/internal/model"
	"github.com/stretchr/testify/assert"
)

func Test_serviceImpl_WriteBookEpub(t *testing.T) {
	t.Parallel()

	tests := []struct {
		name      string
		serv      *serviceImpl
		bk        *model.Book
		chapters  model.Chapters
		want      string
		wantError error
	}{
		{
			name: "happy flow",
			serv: &serviceImpl{},
			bk:   &model.Book{Title: "title", Writer: model.Writer{Name: "writer"}},
			chapters: model.Chapters{
				{Title: "title 1", Content: "content 2"},
			},
			want:      string([]byte("PK\x03\x04\x14\x00\b\x00\b\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x16\x00\x00\x00META-INF/container.xml\\\x8e\xc1J\xc40\x10\x86\xcfݧ\bs\x95n\xf4&\xa1邠W\x05\xf5\x01\xc6t\xba\x06\x93\x99\xa1\x99J}{q\x85e\xd9\xe3\f\xdf\xff\x7f\xffp\xd8jqߴ\xb4,\x1c\xe1n\x7f\v\x8e8ɔ\xf9\x18\xe1\xfd\xed\xa9\xbf\x87ø\xeb\x86$l\x98\x99\x96+x\xab\x85[\x84u\xe1 \xd8r\v\x8c\x95Z\xb0\x14D\x89'Ik%\xb6p\xc2¹\x04\xc6]\xd7u\xc3\"bs.\xd4N\xe7\xc5\xc3\xcdk)\xbd\xa2}Fx~|xy\xf5\x7fQbۋ\xce\xe0*M\x19{\xfbQ\x8a\x80\xaa%'\xb4,\xec\x85>\xb4\xf5\x8a\xe9\v\x8ft\xb3\xd5\x02\xce\xff\x9b\xfc\xa5j\xf0\xe7!\xe3o\x00\x00\x00\xff\xffPK\a\bRu\xcbȹ\x00\x00\x00\x01\x01\x00\x00PK\x03\x04\x14\x00\b\x00\b\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\b\x00\x00\x00mimetypeJ,(\xc8\xc9LN,\xc9\xcc\xcf\xd3O-(MҮ\xca,\x00\x04\x00\x00\xff\xffPK\a\boa\xab,\x1a\x00\x00\x00\x14\x00\x00\x00PK\x03\x04\x14\x00\b\x00\b\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\a\x00\x00\x00toc.ncx\x8c\x91͎\x95@\x10\x85\xd7\xf8\x14e\xed\xa1a\x8cf\xbc\xe9f\x12\x8d\xaeԹ\x89\xe3\xda4t\x85&\xe9\x1f\xd2\x14\\f\x9eހܟ\x85&\xb3\xab*\xce\xf9\xea\x14-\x1f\x16\xef`\xa64\xf61(\xac\x8a\x12\x81B\x1bM\x1f:\x85\xbf\x9e\xbe\xe6\xf7\xf8P\xbf\xc92\x19\xda媻+\xcb\xf7y\x85\xb0xwpz\x95\xbeح\v\xa3B\xcb<\x1c\x848\x9dN\x85\xd1\xfd\xf8\\\xc4ԉ\x97w\x1f\xef?\x88\xd5'B\xbb\b\\\x99\x99\xb4\xa4\xcdVe\xd2\x13k\bړB\xc3\xcd\xc1\xd0\xc0\x16\xa1\x8d\x81)\xb0\xc2;\x145ȷy\x0e\x15\xc4\x04\xb6\xef,%\xc8\xf3\x7f\xbb9\xb2vG\xdd\xd1\xe78\x05\xbe\xc1\x94\x17\x8c\x9fF\x86\x86\xa0\xfc/\xc4\xebeE\xfc\x98|C\xe9u\f)\xce\x17m\x9d\x89\xedSώv>\xd3\xc25\xaf\x03)\xb6\xfa\xaf\xe5V\xb5M\x82\x9e\xbf\xeba7\x05=\x1fc\x1f\x18z\xa30L\xfew\x8508\xfd\xfc\x98\f%\x85\xd5\xfe'\x83\x9e\xbf\xe9\x86\\}\xb3\x05\xaa}\x8f\x14\x97ϛx?\x05\xc6\xd4*|\xfc\xf2\xe9\xf8S\xb4V\x0fLi<\x17yU,\x96\xbdC\xb1\xa7<縶{F\xb9>h\xfd'\x00\x00\xff\xffPK\a\bH\xfd\xd0~@\x01\x00\x00I\x02\x00\x00PK\x03\x04\x14\x00\b\x00\b\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x11\x00\x00\x00OEBPS/cover.xhtmlD\x8dA\u03820\x10F\xd7\xfdOA\xd8t\xf53\x167b\x86r\x17a\xa4MJk\x86\xd1\xe2\xed\r\x98\xc6\xdd\xcb\xe4\xbd\xf9pؖP\xbd\x88W\x9fb\xafMs\xd2\x15\xc51M>ν~\xca\xfd\xff\xa2\a\xfb\xa7\x14:YB\xb5-!\xae}\xedD\x1eW\x80\x9cs\x93\xcfM\xe2\x19L\xd7u\xb0\xedN}ط4\xbdwP8R\x14\xe2\x83\x15:c\xc5K \x04gʉ\xa1Pk3{!Fp\xed7\x86_\x8dP~\"\xec;\xf6\x13\x00\x00\xff\xffPK\a\b\xe4\x01\x92ٌ\x00\x00\x00\xbb\x00\x00\x00PK\x03\x04\x14\x00\b\x00\b\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x11\x00\x00\x00OEBPS/content.opf\x94\x92\xc1\x8e\xd40\f\x86\xcf\xe5)\xaa\\Q\x93\x0e\x1c@\xa3\xb6{\xe3\t\xe0\x01\xbc\x89\xdbZ\xa4I\x94xv\nO\x8f\x9av2;\x80@{ie\xc7\xf9\xfc\xfb\x8f\xbb\xa7u\xb1\xf5\v\xc6D\xde\xf5\xe2$[Q\xa3\xd3ސ\x9bz\xf1\xed\xeb\x97\xe6\xb3x\x1a\xdeUU\x17@\x7f\x87\t\xebu\xb1.\xf5bf\x0eg\xa5\xae\u05eb$\x13F\xe9\xe3\xa4>\xb4\xed'\xe5\xc3(\xee\xc0\x8f\xb2\x15\xdb\xf5\xaa\xea\x16d0\xc0\xb0\x13\xceF\x17H\xb8D\x9b\x01F+\xb4\xb8\xa0\xe3\xa4N\U000a43abU\xd5\x19}fb\x8bC\xfev\xaaį\ntD`\x1f\x0f\xbeK\xed\xffT\xbaԞ\xa3\xb7\xd8\v\xb8\xf0\x1e\x8ed\xb1\x81ԋk$\xc6(\x86\xfd\x9f\x1b\x1e\xfc\xd7--\xb8\xe9\x02\x13\x0e?\xe7\\R\xe2}du\x9b\xf9f\x018\x1a1qA\x10\xe3R\x93酞!0\xc6\xe6$\xea9\xe2X\x12I\x95\x13\xb9μXQ/h\b\x1a\xfe\x116\xdd!X\xd2\xc0\xe4\x9d\xca\xc7\xef\u05edD\xfdـ\xbd\xbe\xa1\xa5T\xec\xb5tz\xfd\a\xac1\xfc\xec\xf4\x9ay\x7f\xc1i\xff\x82\xb1\t0a\x11\xbceޠ1D\x1f02a\xea\x85\x06K\xcf\x11\xf7'ݩ\xaaX\xf8\xe0Y\x97\x029\xac\xd9\xeb}\xa4#\xbb\xe9\x8a8\xd6d\xeeZ\x1e9\xbfW\xdc\xfd.\x9d2:\xef\xba:\x96}\xf8\x15\x00\x00\xff\xffPK\a\b\x9b-\xb0zj\x01\x00\x00\x1f\x03\x00\x00PK\x03\x04\x14\x00\b\x00\b\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1e\x00\x00\x00OEBPS/chapters/chapter-1.xhtmlD\x8e?\x0f\x820\x10\xc5\xe7\xfa)jw9\xab\x8b\x98\x02\x83\x7fV\x1dppTh\x80\xa4\\\t\\,~{Cid\xb9\xbc{\xf9\xfd\x92\xa7\xb2\xb15\xfc\xa3\xfb\xa1\xb1\x98\b\x19m\x05\xd7Xز\xc1*\x11\x8f\xfc\xba9\x88,]1\xc6\xd4\xfa|;\xe5\xcf\xfb\x85\xd7Ԛ\xb9\x9a\x12\x1f[\x83C\"j\xa2\xee\b\xe0\x9c\x8b\xdc>\xb2}\x052\x8ec\x18'F\x04\\\xbfJ\x9f\x18SԐѩ\xbf\\*\x98_O\xc1\x1fSo[~\x83*\x17\xb6\x96sץ\x85E\xd2H|\xa7\xa0\v\xf2\xa2\x80\xdf\xf9\v\x00\x00\xff\xffPK\a\b\x7f\x1a\xda\x1e\x9f\x00\x00\x00\xe1\x00\x00\x00PK\x01\x02\x14\x00\x14\x00\b\x00\b\x00\x00\x00\x00\x00Ru\xcbȹ\x00\x00\x00\x01\x01\x00\x00\x16\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00META-INF/container.xmlPK\x01\x02\x14\x00\x14\x00\b\x00\b\x00\x00\x00\x00\x00oa\xab,\x1a\x00\x00\x00\x14\x00\x00\x00\b\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xfd\x00\x00\x00mimetypePK\x01\x02\x14\x00\x14\x00\b\x00\b\x00\x00\x00\x00\x00H\xfd\xd0~@\x01\x00\x00I\x02\x00\x00\a\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00M\x01\x00\x00toc.ncxPK\x01\x02\x14\x00\x14\x00\b\x00\b\x00\x00\x00\x00\x00\xe4\x01\x92ٌ\x00\x00\x00\xbb\x00\x00\x00\x11\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xc2\x02\x00\x00OEBPS/cover.xhtmlPK\x01\x02\x14\x00\x14\x00\b\x00\b\x00\x00\x00\x00\x00\x9b-\xb0zj\x01\x00\x00\x1f\x03\x00\x00\x11\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x8d\x03\x00\x00OEBPS/content.opfPK\x01\x02\x14\x00\x14\x00\b\x00\b\x00\x00\x00\x00\x00\x7f\x1a\xda\x1e\x9f\x00\x00\x00\xe1\x00\x00\x00\x1e\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x006\x05\x00\x00OEBPS/chapters/chapter-1.xhtmlPK\x05\x06\x00\x00\x00\x00\x06\x00\x06\x00y\x01\x00\x00!\x06\x00\x00\x00\x00")),
			wantError: nil,
		},
	}

	for _, test := range tests {
		test := test

		t.Run(test.name, func(t *testing.T) {
			t.Parallel()

			var buffer bytes.Buffer

			err := test.serv.WriteBookEpub(context.Background(), test.bk, test.chapters, &buffer)
			assert.Equal(t, test.want, buffer.String())
			assert.ErrorIs(t, err, test.wantError)
		})
	}
}
